<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Browser Metronome</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0; padding: 2rem;
      background: #f0f2f5; color: #333;
      display: flex; flex-direction: column; align-items: center;
    }
    h1 { margin-bottom: 1.5rem; }
    .controls {
      width: 100%; max-width: 700px;
      display: flex; flex-direction: column; gap: 1.5rem;
    }
    fieldset.section {
      background: #fff; border: none;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1rem;
    }
    legend { font-weight: bold; padding: 0 0.5rem; }
    .group {
      display: flex; flex-wrap: wrap; gap: 1rem;
      align-items: center; margin-top: 0.5rem;
    }
    .group label,
    .group button,
    .group select,
    .group input[type="number"],
    .group input[type="range"] {
      font-size: 1rem; padding: 0.5rem;
      border: 1px solid #ccc; border-radius: 4px;
      background: #fafafa;
    }
    #start {
      background: #4CAF50; color: white; border: none;
      cursor: pointer; padding: 0.5rem 1rem;
    }
    #start:hover { background: #45A049; }
    #beat-indicator {
      width: 50px; height: 50px; border-radius: 50%;
      background: #ccc; margin-top: 2rem;
      transition: background 0.1s, transform 0.1s;
    }
    #beat-indicator.active {
      background: #f06292; transform: scale(1.2);
    }
    #accentPattern { display: flex; gap: 0.5rem; }
    #accentPattern label {
      display: flex; flex-direction: column;
      align-items: center; font-size: 0.75rem;
    }
    table {
      width: 100%; border-collapse: collapse; margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid #ddd; padding: 0.5rem; text-align: center;
    }
    th { background: #f7f7f7; }
    .remove-change {
      background: #e74c3c; color: white; border: none;
      padding: 0.25rem 0.5rem; cursor: pointer;
    }
    .remove-change:hover { background: #c0392b; }
  </style>
</head>
<body>
  <h1>Browser Metronome</h1>
  <div class="controls">

    <!-- Tempo -->
    <fieldset class="section">
      <legend>Tempo</legend>
      <div class="group">
        <label for="bpm">BPM:</label>
        <input type="number" id="bpm" value="120" min="30" max="300">
        <button id="tap">Tap Tempo</button>
        <button id="start">Start</button>
        <button id="stop" disabled>Stop</button>
      </div>
    </fieldset>

    <!-- Meter & Subdivision -->
    <fieldset class="section">
      <legend>Meter & Subdivision</legend>
      <div class="group">
        <label for="timeSignature">Time Signature:</label>
        <select id="timeSignature">
          <option value="2">2/4</option>
          <option value="3">3/4</option>
          <option value="4" selected>4/4</option>
          <option value="5">5/4</option>
          <option value="6">6/8</option>
          <option value="7">7/8</option>
          <option value="9">9/8</option>
          <option value="11">11/8</option>
          <option value="13">13/8</option>
        </select>
        <label for="subdivision">Subdivision:</label>
        <select id="subdivision">
          <option value="1">None</option>
          <option value="2">8th</option>
          <option value="3">Triplet</option>
          <option value="4">16th</option>
        </select>
      </div>
    </fieldset>

    <!-- Accent Grouping -->
    <fieldset class="section">
      <legend>Accent Grouping</legend>
      <div class="group">
        <label for="grouping">Grouping Pattern:</label>
        <select id="grouping">
          <option value="">—Manual—</option>
        </select>
        <div id="accentPattern"></div>
      </div>
    </fieldset>

    <!-- Tones & Levels -->
    <fieldset class="section">
      <legend>Tones & Levels</legend>
      <div class="group">
        <label for="tone">Main Tone:</label>
        <select id="tone">
          <option value="click">Click</option>
          <option value="tick">Tick</option>
          <option value="bell">Bell</option>
          <option value="wood">Woodblock</option>
        </select>
        <label for="volume">Main Volume:</label>
        <input type="range" id="volume" min="0" max="1" step="0.01" value="1">
      </div>
      <div class="group">
        <label for="accentTone">Accent Tone:</label>
        <select id="accentTone">
          <option value="click">Click</option>
          <option value="tick">Tick</option>
          <option value="bell">Bell</option>
          <option value="wood">Woodblock</option>
        </select>
        <label for="accentVolume">Accent Volume:</label>
        <input type="range" id="accentVolume" min="0" max="1" step="0.01" value="1">
      </div>
      <div class="group">
        <label for="subdivisionTone">Subdivision Tone:</label>
        <select id="subdivisionTone">
          <option value="click">Click</option>
          <option value="tick">Tick</option>
          <option value="bell">Bell</option>
          <option value="wood">Woodblock</option>
        </select>
        <label for="subdivisionVolume">Subdivision Volume:</label>
        <input type="range" id="subdivisionVolume" min="0" max="1" step="0.01" value="0.6">
      </div>
    </fieldset>

    <!-- Tempo Changes -->
    <fieldset class="section">
      <legend>Tempo Changes</legend>
      <table id="tempoChangesTable">
        <thead>
          <tr>
            <th>Start Measure</th><th>Type</th><th>New BPM</th>
            <th>New Meter</th><th>Duration</th><th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="group">
        <label for="changeStart">Start Measure:</label>
        <input type="number" id="changeStart" min="1" value="1">
        <label for="changeType">Type:</label>
        <select id="changeType">
          <option value="sudden">Sudden</option>
          <option value="gradual">Gradual</option>
        </select>
        <label for="changeBpm">New BPM:</label>
        <input type="number" id="changeBpm" min="1" value="100">
        <label for="changeMeter">New Meter:</label>
        <select id="changeMeter">
          <option value="">(same)</option>
          <option value="2">2/4</option>
          <option value="3">3/4</option>
          <option value="4">4/4</option>
          <option value="5">5/4</option>
          <option value="6">6/8</option>
          <option value="7">7/8</option>
          <option value="9">9/8</option>
          <option value="11">11/8</option>
          <option value="13">13/8</option>
        </select>
        <label for="changeDuration">Duration:</label>
        <input type="number" id="changeDuration" min="1" value="1">
        <button id="addChange">Add Change</button>
      </div>
    </fieldset>

    <!-- Presets -->
    <fieldset class="section">
      <legend>Presets</legend>
      <div class="group">
        <input type="text" id="presetName" placeholder="Preset name">
        <button id="savePreset">Save</button>
        <select id="presetList"><option value="">-- Load Preset --</option></select>
        <button id="loadPreset">Load</button>
        <button id="deletePreset">Delete</button>
      </div>
    </fieldset>

  </div>

  <div id="beat-indicator"></div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    let audioCtx, noiseBuffer;

    // Initialize AudioContext and noise buffer
    function initAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext||window.webkitAudioContext)();
        // create 1s noise buffer for woodblock
        const length = audioCtx.sampleRate * 1.0;
        noiseBuffer = audioCtx.createBuffer(1, length, audioCtx.sampleRate);
        const data = noiseBuffer.getChannelData(0);
        for (let i = 0; i < length; i++) data[i] = Math.random()*2 - 1;
      }
    }

    // Element refs
    const bpmInput           = document.getElementById('bpm');
    const subdivisionSel     = document.getElementById('subdivision');
    const tsSel              = document.getElementById('timeSignature');
    const subdivisionToneSel = document.getElementById('subdivisionTone');
    const subdivisionVolCtrl = document.getElementById('subdivisionVolume');
    const groupingSel        = document.getElementById('grouping');
    const volumeCtrl         = document.getElementById('volume');
    const toneSel            = document.getElementById('tone');
    const accentToneSel      = document.getElementById('accentTone');
    const accentVolCtrl      = document.getElementById('accentVolume');
    const beatIndicator      = document.getElementById('beat-indicator');
    const startBtn           = document.getElementById('start');
    const stopBtn            = document.getElementById('stop');
    const tapBtn             = document.getElementById('tap');
    const saveBtn            = document.getElementById('savePreset');
    const loadBtn            = document.getElementById('loadPreset');
    const deleteBtn          = document.getElementById('deletePreset');
    const presetList         = document.getElementById('presetList');
    const presetNameIn       = document.getElementById('presetName');
    const accentCont         = document.getElementById('accentPattern');

    const tableBody      = document.querySelector('#tempoChangesTable tbody');
    const changeStart    = document.getElementById('changeStart');
    const changeType     = document.getElementById('changeType');
    const changeBpm      = document.getElementById('changeBpm');
    const changeMeter    = document.getElementById('changeMeter');
    const changeDuration = document.getElementById('changeDuration');
    const addChangeBtn   = document.getElementById('addChange');

    // State
    let timerId;
    let globalBeatCount = 0, globalMainBeatCount = 0;
    let measureCount = 1;
    let lastMainBeatIdx = null;
    let currentBpm = +bpmInput.value;
    let currentMeter = +tsSel.value;
    let currentSubdivision = +subdivisionSel.value;
    let accentCheckboxes = [];
    let taps = [];
    let tempoChanges = [];

    // Grouping presets
    const groupingOptions = {
      5:  [ [2,3], [3,2] ],
      7:  [ [2,2,3], [2,3,2], [3,2,2] ],
      11: [ [3,3,3,2], [3,3,2,3], [3,2,3,3], [2,3,3,3] ],
      13: [ [3,3,3,2,2], [3,3,2,3,2], [3,2,3,3,2], [2,3,3,3,2] ]
    };
    function updateGroupingOptions() {
      const beats = +tsSel.value;
      groupingSel.innerHTML = '<option value="">—Manual—</option>';
      (groupingOptions[beats]||[]).forEach(g=>{
        const opt = document.createElement('option');
        opt.value = g.join(',');
        opt.textContent = g.join(' + ');
        groupingSel.appendChild(opt);
      });
    }

    // Accent pattern
    function updateAccentPattern() {
      accentCont.innerHTML = '';
      accentCheckboxes = [];
      const beats = currentMeter;
      const checks = Array(beats).fill(false);
      if (groupingSel.value) {
        let idx=0;
        groupingSel.value.split(',').map(Number)
          .forEach(size=>{ checks[idx]=true; idx+=size; });
      } else {
        checks[0]=true;
      }
      checks.forEach((on,i)=>{
        const cb = document.createElement('input');
        cb.type='checkbox'; cb.checked=on;
        const lbl = document.createElement('label');
        lbl.textContent = i+1;
        lbl.appendChild(cb);
        accentCont.appendChild(lbl);
        accentCheckboxes.push(cb);
      });
    }

    // Tempo‐changes table
    function renderTempoChanges() {
      tableBody.innerHTML = '';
      tempoChanges.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.startMeasure}</td>
          <td>${r.type}</td>
          <td>${r.newBpm}</td>
          <td>${r.newMeter||'—'}</td>
          <td>${r.duration}</td>
          <td><button class="remove-change" data-idx="${i}">✕</button></td>
        `;
        tableBody.appendChild(tr);
      });
      document.querySelectorAll('.remove-change').forEach(btn=>{
        btn.onclick = ()=>{
          tempoChanges.splice(+btn.dataset.idx,1);
          renderTempoChanges();
        };
      });
    }

    // Add change
    addChangeBtn.addEventListener('click', ()=>{
      const rule = {
        startMeasure: Math.max(1,parseInt(changeStart.value,10)),
        type: changeType.value,
        newBpm: Math.max(1,parseInt(changeBpm.value,10)),
        newMeter: changeMeter.value?parseInt(changeMeter.value,10):null,
        duration: Math.max(1,parseInt(changeDuration.value,10)),
        _inProgress:false, _meterChanged:false
      };
      tempoChanges.push(rule);
      tempoChanges.sort((a,b)=>a.startMeasure-b.startMeasure);
      renderTempoChanges();
    });

    // Woodblock via filtered noise
    function playWood(isAccent) {
      initAudio();
      const now = audioCtx.currentTime;
      const src = audioCtx.createBufferSource();
      src.buffer = noiseBuffer;
      const filter = audioCtx.createBiquadFilter();
      filter.type = 'bandpass';
      filter.frequency.value = 2000;
      filter.Q.value = 5;
      const gain = audioCtx.createGain();
      src.connect(filter);
      filter.connect(gain);
      gain.connect(audioCtx.destination);

      const vol = isAccent
        ? parseFloat(accentVolCtrl.value)
        : parseFloat(volumeCtrl.value);
      gain.gain.setValueAtTime(vol, now);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.05);

      src.start(now);
      src.stop(now + 0.05);
    }

    // Main click
    function playMain(isAccent) {
      initAudio();
      const tone = isAccent ? accentToneSel.value : toneSel.value;
      if (tone === 'wood') {
        playWood(isAccent);
        return;
      }
      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      // Only filter 'click'
      if (tone === 'click') {
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'highpass';
        filter.frequency.value = 1500;
        osc.connect(filter);
        filter.connect(gain);
      } else {
        osc.connect(gain);
      }
      gain.connect(audioCtx.destination);

      osc.type = tone === 'click' ? 'square'
               : tone === 'tick'  ? 'sine'
                                  : 'triangle';
      osc.frequency.setValueAtTime(
        tone==='click'?1000
        : tone==='tick'?600
        :1200, now
      );

      const vol = isAccent
        ? parseFloat(accentVolCtrl.value)
        : parseFloat(volumeCtrl.value);
      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(vol, now + 0.001);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.03);

      osc.start(now);
      osc.stop(now + 0.03);
    }

    // Subdivision click
    function playSub() {
      initAudio();
      const tone = subdivisionToneSel.value;
      if (tone === 'wood') {
        // wood
        const now = audioCtx.currentTime;
        const src = audioCtx.createBufferSource();
        src.buffer = noiseBuffer;
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'bandpass';
        filter.frequency.value = 2000;
        filter.Q.value = 5;
        const gain = audioCtx.createGain();
        src.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);

        const vol = parseFloat(subdivisionVolCtrl.value);
        gain.gain.setValueAtTime(vol, now);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.02);

        src.start(now);
        src.stop(now + 0.02);
        return;
      }

      const now = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      // Only filter click
      if (tone === 'click') {
        const filter = audioCtx.createBiquadFilter();
        filter.type = 'highpass';
        filter.frequency.value = 1500;
        osc.connect(filter);
        filter.connect(gain);
      } else {
        osc.connect(gain);
      }
      gain.connect(audioCtx.destination);

      osc.type = tone==='click'?'square':tone==='tick'?'sine':'triangle';
      osc.frequency.setValueAtTime(
        tone==='click'?1000:tone==='tick'?600:1200, now
      );

      const vol = parseFloat(subdivisionVolCtrl.value);
      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(vol, now + 0.001);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.02);

      osc.start(now);
      osc.stop(now + 0.02);
    }

    function flash() {
      beatIndicator.classList.add('active');
      setTimeout(()=>beatIndicator.classList.remove('active'),100);
    }

    // Scheduler
    function doTick() {
      const sub = currentSubdivision;
      const isMain = (globalBeatCount % sub === 0);
      if (isMain) globalMainBeatCount++;
      // figure out where we are "in the bar"

      const beatIdx = Math.floor(globalBeatCount/sub) % currentMeter;

      // detect the very first main‐beat of each measure
      // (beatIdx === 0 means first beat of the bar)
      if (isMain) {
        // only bump measureCount on a true bar-boundary (beatIdx=0),
        // and not on the very first beat when lastMainBeatIdx===null
        if (
          beatIdx === 0 &&
          lastMainBeatIdx !== null &&    // <-- skip if we haven't seen any beat yet
          lastMainBeatIdx !== 0          // <-- skip the “carry-over” edge
        ) {
          measureCount++;
        }
        lastMainBeatIdx = beatIdx;
      }

      tempoChanges.forEach(r=>{
        // Apply the change BEFORE the first beat of the bar
        if (r.type === 'sudden' && isMain && measureCount === r.startMeasure - 1 && beatIdx === currentMeter - 1) {
          currentBpm = r.newBpm;
          if (r.newMeter) {
            currentMeter = r.newMeter;
            tsSel.value = String(r.newMeter);
            updateAccentPattern();
          }
        }
        if (r.type==='gradual') {
          const startBeat = (r.startMeasure-1)*currentMeter;
          const totalBeats = r.duration*currentMeter;
          if (globalMainBeatCount>=startBeat && globalMainBeatCount<=startBeat+totalBeats) {
            if (!r._inProgress) {
              r._inProgress = true;
              r._initialBpm = currentBpm;
            }
            const elapsed = globalMainBeatCount-startBeat;
            const ratio   = Math.min(elapsed/totalBeats,1);
            currentBpm = r._initialBpm + ratio*(r.newBpm-r._initialBpm);
            if (r.newMeter && ratio>=1 && !r._meterChanged) {
              currentMeter = r.newMeter;
              tsSel.value   = String(r.newMeter);
              updateAccentPattern();
              r._meterChanged = true;
            }
          }
        }
      });

      if (!audioCtx) initAudio();
      if (!isMain) playSub();
      else {
        const isAccent = accentCheckboxes[beatIdx % accentCheckboxes.length]?.checked ?? false;
        playMain(isAccent);
      }
      flash();

      globalBeatCount++;
      const interval = (60/currentBpm)*1000/currentSubdivision;
      timerId = setTimeout(doTick, interval);
    }

    function startMetronome() {
      globalBeatCount=0; globalMainBeatCount=0; measureCount=1; lastMainBeatIdx=null;
      tempoChanges.forEach(r=>{ r._inProgress=false; r._meterChanged=false; });
      currentBpm = +bpmInput.value;
      currentMeter = +tsSel.value;
      currentSubdivision = +subdivisionSel.value;
      startBtn.disabled=true; stopBtn.disabled=false;
      doTick();
    }
    function stopMetronome() {
      clearTimeout(timerId);
      startBtn.disabled=false; stopBtn.disabled=true;
    }

    // Presets
    function loadPresets() {
      const store = JSON.parse(localStorage.getItem('metronomePresets')||'{}');
      presetList.innerHTML = '<option value="">-- Load Preset --</option>';
      Object.keys(store).forEach(name => presetList.appendChild(new Option(name,name)));
    }
    saveBtn.addEventListener('click', ()=>{
      const name = presetNameIn.value.trim();
      if (!name) return alert('Enter preset name');
      const store = JSON.parse(localStorage.getItem('metronomePresets')||'{}');
      store[name] = {
        bpm: bpmInput.value,
        subdivision: subdivisionSel.value,
        timeSignature: tsSel.value,
        grouping: groupingSel.value,
        tone: toneSel.value,
        volume: volumeCtrl.value,
        accentTone: accentToneSel.value,
        accentVolume: accentVolCtrl.value,
        subdivisionTone: subdivisionToneSel.value,
        subdivisionVolume: subdivisionVolCtrl.value,
        tempoChanges
      };
      localStorage.setItem('metronomePresets', JSON.stringify(store));
      loadPresets(); presetNameIn.value = '';
    });
    loadBtn.addEventListener('click', ()=>{
      const name = presetList.value;
      if (!name) return;
      const store = JSON.parse(localStorage.getItem('metronomePresets')||'{}');
      const p = store[name];
      bpmInput.value           = p.bpm;
      subdivisionSel.value     = p.subdivision;
      tsSel.value              = p.timeSignature;
      groupingSel.value        = p.grouping;
      toneSel.value            = p.tone;
      volumeCtrl.value         = p.volume;
      accentToneSel.value      = p.accentTone;
      accentVolCtrl.value      = p.accentVolume;
      subdivisionToneSel.value = p.subdivisionTone;
      subdivisionVolCtrl.value = p.subdivisionVolume;
      tempoChanges             = p.tempoChanges||[];
      renderTempoChanges();
      updateGroupingOptions();
      updateAccentPattern();
    });
    deleteBtn.addEventListener('click', ()=>{
      const name = presetList.value;
      if (!name) return;
      const store = JSON.parse(localStorage.getItem('metronomePresets')||'{}');
      delete store[name];
      localStorage.setItem('metronomePresets', JSON.stringify(store));
      loadPresets();
    });

    // UI hooks
    groupingSel.addEventListener('change', updateAccentPattern);
    tsSel.addEventListener('change', ()=>{
      currentMeter = +tsSel.value;
      updateGroupingOptions();
      updateAccentPattern();
    });
    subdivisionSel.addEventListener('change', ()=>{
      currentSubdivision = +subdivisionSel.value;
    });
    tapBtn.addEventListener('click', ()=>{
      taps.push(Date.now());
      if (taps.length>5) taps.shift();
      if (taps.length>1) {
        const ivs = taps.slice(1).map((t,i)=>t - taps[i]);
        bpmInput.value = Math.round(60000/(ivs.reduce((a,b)=>a+b)/ivs.length));
      }
    });
    startBtn.addEventListener('click', startMetronome);
    stopBtn.addEventListener('click', stopMetronome);

    // Init
    initAudio();
    updateGroupingOptions();
    updateAccentPattern();
    renderTempoChanges();
    loadPresets();
  });
  </script>
</body>
</html>
